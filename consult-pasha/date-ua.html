<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Запис на консультацію</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .question-label {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .answer-field {
      height: 120px;
      resize: none;
      overflow: auto;
    }
        .question-label {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .answer-field {
      height: 120px;
      resize: none;
      overflow: auto;
    }
    input[type="date"]::-webkit-datetime-edit-text,
    input[type="date"]::-webkit-datetime-edit-month-field,
    input[type="date"]::-webkit-datetime-edit-day-field,
    input[type="date"]::-webkit-datetime-edit-year-field {
      display: inline-block;
      color: inherit;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator {
      background: transparent;
      bottom: 0;
      color: transparent;
      cursor: pointer;
      height: auto;
      left: auto;
      right: 0;
      position: absolute;
      top: 0;
      width: 30px;
      z-index: 1;
    }
    
    input[type="date"] {
      position: relative;
      text-align: left;
      cursor: pointer;
      padding-right: 35px;
    }
    
    input[type="date"]:before {
      content: attr(placeholder);
      position: absolute;
      left: 12px;
      color: #6c757d;
      z-index: 0;
      pointer-events: none;
      display: none;
    }
    
    input[type="date"]:not(:valid):before {
      display: block;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-3">
    <h1 class="mb-4 text-center">Запис на консультацію</h1>

<div id="questions">
    <div class="mb-3">
        <label for="dateField" class="question-label">Виберіть дату</label>
        <input type="date" id="dateField" class="form-control" placeholder="Оберіть дату" required style="text-align: center;">
    </div>
    <div class="mb-3">
        <!-- <label for="timeField" class="question-label">Виберіть зручний час * вказано за часовим поясом Києва</label> -->
        <select id="timeField" class="form-select d-none">
          <option value="">Оберіть час...</option>
        </select>
    </div>
</div>
<div id="customAlert" class="alert d-none" role="alert" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px; text-align: center;">
    <span id="alertMessage"></span>
    <button id="alertCloseBtn" class="btn-close float-end" style="display: none;"></button>
</div>

    <button class="btn btn-primary w-100" onclick="sendData()">Надіслати</button>
  </div>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

        function showAlert(message, type, persistent = false) {
        const alertDiv = document.getElementById('customAlert');
        const alertMessage = document.getElementById('alertMessage');
        const closeBtn = document.getElementById('alertCloseBtn');
        
        alertMessage.textContent = message;
        alertDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
        
        if (type === 'ok') {
            alertDiv.classList.add('alert-success');
        } else {
            alertDiv.classList.add('alert-danger');
        }
        
        if (persistent) {
            closeBtn.style.display = 'inline-block';
            closeBtn.onclick = function() {
                alertDiv.classList.add('d-none');
            };
        } else {
            closeBtn.style.display = 'none';
            setTimeout(() => {
                alertDiv.classList.add('d-none');
            }, 5000);
        }
    }
    
    function updateTimeSelect(times) {
        const timeSelect = document.getElementById('timeField');
        timeSelect.innerHTML = '<option value="">Оберіть час...</option>';
        
        times.forEach(time => {
            const option = document.createElement('option');
            option.value = time;
            option.textContent = time;
            timeSelect.appendChild(option);
        });
        
        timeSelect.classList.remove('d-none');
    }

    
    function setupDateRestrictions() {
      const dateInput = document.getElementById('dateField');
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      
      // Встановлюємо мінімальну дату - сьогодні
      dateInput.min = `${yyyy}-${mm}-${dd}`;
            // Додаємо окремий обробник для очищення
      dateInput.addEventListener('mousedown', function(e) {
        // Запам'ятовуємо значення до кліку
        const previousValue = this.value;
        
        // Перевіряємо через невеликий проміжок часу чи змінилося значення
        setTimeout(() => {
          if (this.value !== previousValue && !this.value) {
            // Значення очистилося
            document.getElementById('timeField').classList.add('d-none');
            document.getElementById('customAlert').classList.add('d-none');
          }
        }, 20);
      });
      // Додаємо обробник для блокування серед
      // Додаємо обробник для блокування серед та відправки запиту
      dateInput.addEventListener('input', function() {
         if (!this.value) {
          // Ховаємо вибір часу
          document.getElementById('timeField').classList.add('d-none');
          // Ховаємо алерт якщо він був показаний
          document.getElementById('customAlert').classList.add('d-none');
          return;
        }

        const selectedDate = new Date(this.value);
        const dayOfWeek = selectedDate.getDay(); // 3 = середа
        
        if (dayOfWeek === 3) { // середа
          this.value = '';
          showAlert("Середи недоступні для запису. Будь ласка, оберіть інший день.", "error", true);
          document.getElementById('timeField').classList.add('d-none');

          return;
        }
        
        // Відправляємо запит з вибраною датою
        const data = {
          bot: '@PavloKazarianBot',
          task: 'GET',
          sub: 'windows',
          user: tg.initDataUnsafe.user,
          date: this.value,
          status_msg: true
        };
        
        fetch("https://n8n.psyhodoc.xyz/webhook/kons-user-date", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
        .then(res => res.json())
        .then(result => {
          if (result.status === "ok") {
            if (result.allert.type === "ok") {
              // Показуємо тимчасовий алерт і оновлюємо час
              showAlert(result.allert.text, "ok", false);
              if (result.data && result.data.length > 0) {
                updateTimeSelect(result.data);
              }
            } else {
              // Показуємо персистентний алерт з кнопкою
              showAlert(result.allert.text, "error", true);
              // Ховаємо вибір часу якщо він був показаний
              document.getElementById('timeField').classList.add('d-none');
            }
          } else {
            showAlert("Помилка при отриманні даних", "error", true);
          }
        })
        .catch(err => {
          console.error("Помилка:", err);
          showAlert("Помилка при отриманні даних", "error", true);
        });
      });
      
      // Додаємо обробник щоб відкривати календар при кліку на поле
      dateInput.addEventListener('click', function(e) {
        // Якщо клік не по іконці календаря, все одно відкриваємо календар
        this.showPicker();
      });
      
      // Встановлюємо початковий стан
      dateInput.classList.add('interacted');
    }
    // Викликаємо функцію після завантаження
    setupDateRestrictions();

        function sendData() {
      const dateField = document.getElementById('dateField');
      const timeField = document.getElementById('timeField');
      
      // Перевірка: чи вибрана дата
      if (!dateField.value) {
        tg.showAlert("Будь ласка, оберіть дату!");
        dateField.focus();
        return;
      }
      
      // Перевірка: чи вибраний час (поле видиме і має значення)
      if (timeField.classList.contains('d-none') || !timeField.value) {
        tg.showAlert("Будь ласка, оберіть час!");
        if (!timeField.classList.contains('d-none')) {
          timeField.focus();
        }
        return;
      }

      // Формуємо дані для відправки
      const data = {
        bot: '@PavloKazarianBot',
        task: 'CREATE',
        sub: 'appointment',
        user: tg.initDataUnsafe.user,
        date: dateField.value,
        time: timeField.value,
        status_msg: true
      };

      // Показуємо індикатор завантаження (опціонально)
      tg.showAlert("Відправка даних...");
      
      fetch("https://n8n.psyhodoc.xyz/webhook/kons-user-date", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      })
      .then(res => {
        if (!res.ok) throw new Error("HTTP error " + res.status);
        return res.json();
      })
      .then(result => {
        console.log("✅ Успіх:", result);
        
        if (result.status === "ok") {
          // Показуємо успішне повідомлення
          showAlert(result.allert?.text || "Запис створено успішно!", "ok", false);
          // Закриваємо через 2 секунди
          setTimeout(() => {
            tg.close();
          }, 2000);
        } else {
          // Показуємо помилку
          showAlert(result.allert?.text || "Помилка при створенні запису", "error", true);
        }
      })
      .catch(err => {
        console.error("❌ Помилка:", err);
        showAlert("Помилка при відправці: " + err.message, "error", true);
        
        // Відправляємо помилку в лог
        const errorData = {
          bot: '@Bulanova_school_bot',
          task: 1,
          user: tg.initDataUnsafe.user,
          error: err.message,
          status_msg: false
        };
        fetch("https://n8n.psyhodoc.xyz/webhook/kons-user-new", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(errorData),
        });
      });
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>